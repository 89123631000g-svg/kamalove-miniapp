<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>KamaLove</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root{
    --bg:#fff;
    --text:#111;
    --muted:#777;
    --border:#ececec;
    --card:#fff;
  }

  html,body{
    margin:0;
    padding:0;
    height:100%;
    background:var(--bg);
    color:var(--text);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }

  /* –≥–ª–∞–≤–Ω–æ–µ: dvh –¥–ª—è Telegram Desktop + fallback */
  .app{
    max-width: 480px;
    margin: 0 auto;
    height: 100vh;
    height: 100dvh;
    display:flex;
    flex-direction:column;
    background:var(--bg);
  }

  .top{
    flex:0 0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding: 12px 14px;
    padding-top: calc(12px + env(safe-area-inset-top));
  }

  .brand{
    font-weight:900;
    letter-spacing: .2px;
    font-size:18px;
    line-height:1.1;
  }

  .sub{
    font-size:12px;
    color:var(--muted);
    margin-top:2px;
  }

  .btn{
    border:1px solid var(--border);
    background:#fff;
    border-radius: 14px;
    padding: 10px 12px;
    font-weight: 700;
    cursor:pointer;
  }

  /* –∫–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –¥–æ—Å—Ç—É–ø–Ω–æ–µ –º–µ—Å—Ç–æ –º–µ–∂–¥—É top –∏ actionbar */
  .stage{
    flex: 1 1 auto;
    min-height: 0; /* –≤–∞–∂–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –≤—ã—Å–æ—Ç—ã –Ω–∞ desktop webview */
    padding: 0 14px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .card{
    flex: 1 1 auto;
    min-height: 0;
    border:1px solid var(--border);
    border-radius: 20px;
    overflow:hidden;
    background:var(--card);
    display:flex;
    flex-direction:column;
  }

  .photo{
    flex: 1 1 auto;
    min-height: 0;
    width:100%;
    object-fit:cover;
    background:#f2f2f2;
  }

  .info{
    padding: 12px 12px 10px;
  }

  .titleRow{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
  }

  .name{
    font-size:20px;
    font-weight:900;
  }

  .city{
    font-size:12px;
    color:var(--muted);
    white-space:nowrap;
  }

  .about{
    margin-top:6px;
    font-size:14px;
    line-height:1.35;
    color:#333;
  }

  .hint{
    text-align:center;
    font-size:12px;
    color:var(--muted);
    min-height: 16px;
    padding-bottom: 6px;
  }

  /* action bar –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω */
  .actions{
    position: sticky;
    bottom: 0;
    flex: 0 0 auto;
    padding: 10px 14px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background: rgba(255,255,255,0.96);
    backdrop-filter: blur(6px);
    border-top: 1px solid var(--border);
    display:flex;
    justify-content:center;
    gap: 14px;
  }

  .round{
    width:64px;
    height:64px;
    border-radius:999px;
    border:1px solid var(--border);
    background:#fff;
    font-size:22px;
    cursor:pointer;
  }

  /* overlays */
  .overlay{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.4);
    display:none;
    align-items:flex-end;
    justify-content:center;
    padding: 12px;
    padding-bottom: calc(12px + env(safe-area-inset-bottom));
  }

  .sheet{
    width: min(480px, 100%);
    background:#fff;
    border-radius: 18px;
    border:1px solid var(--border);
    max-height: 82dvh;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .sheetTop{
    padding: 12px 14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid var(--border);
  }

  .sheetTitle{
    font-weight:900;
  }

  .list{
    padding: 10px 14px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .item{
    display:flex;
    gap:10px;
    align-items:center;
    border:1px solid var(--border);
    border-radius: 14px;
    padding: 10px;
    cursor:pointer;
  }

  .ava{
    width:44px;
    height:44px;
    border-radius: 12px;
    object-fit:cover;
    background:#f2f2f2;
    flex:0 0 auto;
  }

  .itName{ font-weight:900; margin:0; }
  .itSub{ margin:2px 0 0; font-size:12px; color:var(--muted); }

  /* chat */
  .chatBox{
    flex:1 1 auto;
    overflow:auto;
    padding: 10px 14px;
    background:#fff;
  }

  .msg{ margin:8px 0; display:flex; }
  .msg.user{ justify-content:flex-end; }
  .bubble{
    max-width: 80%;
    padding: 10px 12px;
    border-radius: 16px;
    border: 1px solid var(--border);
    background:#f7f7f7;
    font-size:14px;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user .bubble{
    background:#111;
    color:#fff;
    border-color:#111;
  }

  .composer{
    display:flex;
    gap:8px;
    padding: 10px 14px;
    border-top:1px solid var(--border);
    background:#fff;
  }
  .inp{
    flex:1;
    border:1px solid var(--border);
    border-radius: 14px;
    padding: 12px;
    font-size:14px;
  }
  .send{
    border:1px solid #111;
    background:#111;
    color:#fff;
    border-radius: 14px;
    padding: 12px 14px;
    font-weight:900;
    cursor:pointer;
  }
</style>
</head>

<body>
<div class="app">
  <div class="top">
    <div>
      <div class="brand">KamaLove</div>
      <div class="sub" id="who"></div>
    </div>
    <button class="btn" id="openMessages">üí¨ –°–æ–æ–±—â–µ–Ω–∏—è</button>
  </div>

  <div class="stage">
    <div class="card">
      <img id="photo" class="photo" alt="">
      <div class="info">
        <div class="titleRow">
          <div class="name" id="name">‚Äî</div>
          <div class="city" id="city">‚Äî</div>
        </div>
        <div class="about" id="about">‚Äî</div>
      </div>
    </div>

    <div class="hint" id="hint"></div>
  </div>

  <div class="actions">
    <button class="round" id="nope">‚ùå</button>
    <button class="round" id="like">‚ù§Ô∏è</button>
  </div>
</div>

<!-- Messages overlay -->
<div class="overlay" id="messagesOv">
  <div class="sheet">
    <div class="sheetTop">
      <div class="sheetTitle">–°–æ–æ–±—â–µ–Ω–∏—è</div>
      <button class="btn" id="closeMessages">‚úï</button>
    </div>
    <div class="list" id="messagesList"></div>
  </div>
</div>

<!-- Chat overlay -->
<div class="overlay" id="chatOv">
  <div class="sheet">
    <div class="sheetTop">
      <div class="sheetTitle" id="chatTitle">–ß–∞—Ç</div>
      <button class="btn" id="closeChat">‚úï</button>
    </div>
    <div class="chatBox" id="chatBox"></div>
    <div class="composer">
      <input class="inp" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button class="send" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
  const API = "https://kamalove-api.89123631000g.workers.dev";
  const APP_VER = "v5"; // –º–µ–Ω—è–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏, —á—Ç–æ–±—ã –ø—Ä–æ–±–∏–≤–∞—Ç—å –∫—ç—à Telegram

  const tg = window.Telegram?.WebApp;
  tg?.ready();

  const tg_id = (tg?.initDataUnsafe?.user?.id?.toString()) || "111";
  document.getElementById("who").textContent = "tg_id: " + tg_id + " ‚Ä¢ " + APP_VER;

  let current = null;
  let currentChatProfileId = null;
  let currentChatName = "";

  const hint = document.getElementById("hint");
  const photo = document.getElementById("photo");
  const nameEl = document.getElementById("name");
  const cityEl = document.getElementById("city");
  const aboutEl = document.getElementById("about");

  async function loadFeed() {
    hint.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶";
    try {
      const r = await fetch(`${API}/feed?tg_id=${encodeURIComponent(tg_id)}&v=${APP_VER}`);
      const d = await r.json();
      if (!d.ok) { hint.textContent = d.error || "–û—à–∏–±–∫–∞"; return; }

      current = d.profiles?.[0] || null;
      if (!current) {
        hint.textContent = "–õ–µ–Ω—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å (–¥–µ–º–æ).";
        photo.src = "";
        nameEl.textContent = "‚Äî";
        cityEl.textContent = "‚Äî";
        aboutEl.textContent = "‚Äî";
        return;
      }

      photo.src = current.photo_url || "";
      nameEl.textContent = `${current.name}, ${current.age}`;
      cityEl.textContent = current.city || "";
      aboutEl.textContent = current.about || "";
      hint.textContent = "";
    } catch (e) {
      hint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    }
  }

  async function swipe(action) {
    if (!current) return;
    hint.textContent = "‚Ä¶";
    try {
      const r = await fetch(`${API}/swipe?v=${APP_VER}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tg_id, profile_id: current.id, action })
      });
      const d = await r.json();
      if (!d.ok) { hint.textContent = d.error || "–û—à–∏–±–∫–∞"; return; }
      hint.textContent = (action === "like" && d.matched) ? "–ü–æ—è–≤–∏–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–µ üí¨" : "";
      await loadFeed();
    } catch (e) {
      hint.textContent = "–û—à–∏–±–∫–∞";
    }
  }

  document.getElementById("like").onclick = () => swipe("like");
  document.getElementById("nope").onclick = () => swipe("nope");

  // Messages overlay
  const messagesOv = document.getElementById("messagesOv");
  const messagesList = document.getElementById("messagesList");

  document.getElementById("openMessages").onclick = async () => {
    messagesOv.style.display = "flex";
    await loadMessages();
  };
  document.getElementById("closeMessages").onclick = () => {
    messagesOv.style.display = "none";
  };

  async function loadMessages() {
    messagesList.innerHTML = `<div style="font-size:12px;color:#777">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`;
    try {
      const r = await fetch(`${API}/matches?tg_id=${encodeURIComponent(tg_id)}&v=${APP_VER}`);
      const d = await r.json();
      if (!d.ok) { messagesList.innerHTML = `<div style="font-size:12px;color:#777">${d.error||"–û—à–∏–±–∫–∞"}</div>`; return; }

      const arr = d.matches || [];
      if (arr.length === 0) {
        messagesList.innerHTML = `<div style="font-size:12px;color:#777">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤. –ü–æ—Å—Ç–∞–≤—å ‚ù§Ô∏è</div>`;
        return;
      }

      messagesList.innerHTML = "";
      arr.forEach(m => {
        const it = document.createElement("div");
        it.className = "item";
        it.onclick = () => openChat(m.profile_id, m.name);

        const img = document.createElement("img");
        img.className = "ava";
        img.src = m.photo_url || "";

        const box = document.createElement("div");
        const t = document.createElement("div");
        t.className = "itName";
        t.textContent = `${m.name}, ${m.age}`;

        const s = document.createElement("div");
        s.className = "itSub";
        s.textContent = (m.city || "") + (m.about ? " ‚Ä¢ " + m.about : "");

        box.appendChild(t);
        box.appendChild(s);

        it.appendChild(img);
        it.appendChild(box);

        messagesList.appendChild(it);
      });
    } catch (e) {
      messagesList.innerHTML = `<div style="font-size:12px;color:#777">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
    }
  }

  // Chat overlay
  const chatOv = document.getElementById("chatOv");
  const chatTitle = document.getElementById("chatTitle");
  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const sendBtn = document.getElementById("sendBtn");

  document.getElementById("closeChat").onclick = () => {
    chatOv.style.display = "none";
  };

  async function openChat(profile_id, name) {
    currentChatProfileId = profile_id;
    currentChatName = name || "";
    chatTitle.textContent = currentChatName ? `–ß–∞—Ç: ${currentChatName}` : "–ß–∞—Ç";
    messagesOv.style.display = "none";
    chatOv.style.display = "flex";
    await loadThread();
  }

  async function loadThread() {
    chatBox.innerHTML = `<div style="font-size:12px;color:#777">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>`;
    try {
      const r = await fetch(`${API}/thread?tg_id=${encodeURIComponent(tg_id)}&profile_id=${encodeURIComponent(currentChatProfileId)}&v=${APP_VER}`);
      const d = await r.json();
      if (!d.ok) { chatBox.innerHTML = `<div style="font-size:12px;color:#777">${d.error||"–û—à–∏–±–∫–∞"}</div>`; return; }

      const msgs = d.messages || [];
      chatBox.innerHTML = "";
      if (msgs.length === 0) {
        chatBox.innerHTML = `<div style="font-size:12px;color:#777">–ù–∞–ø–∏—à–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>`;
        return;
      }

      msgs.forEach(m => {
        const row = document.createElement("div");
        row.className = "msg " + (m.sender === "user" ? "user" : "profile");
        const b = document.createElement("div");
        b.className = "bubble";
        b.textContent = m.text;
        row.appendChild(b);
        chatBox.appendChild(row);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    } catch (e) {
      chatBox.innerHTML = `<div style="font-size:12px;color:#777">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
    }
  }

  sendBtn.onclick = async () => {
    const text = (chatInput.value || "").trim();
    if (!text || !currentChatProfileId) return;

    sendBtn.disabled = true;
    try {
      const r = await fetch(`${API}/message?v=${APP_VER}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tg_id, profile_id: currentChatProfileId, text })
      });
      const d = await r.json();
      if (d.ok) {
        chatInput.value = "";
        await loadThread();
      }
    } finally {
      sendBtn.disabled = false;
    }
  };

  loadFeed();
</script>
</body>
</html>
