<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>KamaLove</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
html,body{
  margin:0;
  height:100%;
  background:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#111;
}
.app{
  max-width:420px;
  margin:0 auto;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.header{
  padding:12px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.logo{
  font-weight:800;
  font-size:18px;
}
.msgBtn{
  border:1px solid #ddd;
  background:#fff;
  border-radius:14px;
  padding:8px 12px;
  font-weight:600;
}
.stage{
  flex:1;
  padding:0 14px 12px;
  display:flex;
  flex-direction:column;
}
.card{
  flex:1;
  border:1px solid #eee;
  border-radius:18px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.photo{
  flex:1;
  width:100%;
  object-fit:cover;
  background:#f2f2f2;
}
.info{
  padding:12px;
}
.name{
  font-size:20px;
  font-weight:800;
}
.city{
  font-size:12px;
  color:#777;
}
.about{
  margin-top:6px;
  font-size:14px;
  line-height:1.35;
}
.actions{
  display:flex;
  justify-content:center;
  gap:20px;
  padding:12px 0;
}
.action{
  width:64px;
  height:64px;
  border-radius:50%;
  border:1px solid #ddd;
  font-size:22px;
  background:#fff;
}
.hint{
  text-align:center;
  font-size:12px;
  color:#777;
  min-height:16px;
}

/* overlay */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  justify-content:center;
  align-items:flex-end;
}
.sheet{
  width:100%;
  max-width:420px;
  background:#fff;
  border-radius:18px 18px 0 0;
  max-height:80vh;
  display:flex;
  flex-direction:column;
}
.sheetHeader{
  padding:12px 14px;
  font-weight:800;
  border-bottom:1px solid #eee;
}
.list{
  overflow:auto;
  padding:10px 14px;
}
.item{
  display:flex;
  gap:10px;
  padding:10px;
  border:1px solid #eee;
  border-radius:14px;
  margin-bottom:10px;
}
.ava{
  width:44px;
  height:44px;
  border-radius:12px;
  object-fit:cover;
}
.chat{
  flex:1;
  overflow:auto;
  padding:10px 14px;
}
.msg{
  margin:6px 0;
  display:flex;
}
.msg.user{justify-content:flex-end}
.bubble{
  max-width:75%;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid #eee;
}
.msg.user .bubble{
  background:#111;
  color:#fff;
  border-color:#111;
}
.inputRow{
  display:flex;
  gap:8px;
  padding:10px 14px;
  border-top:1px solid #eee;
}
.input{
  flex:1;
  border:1px solid #ddd;
  border-radius:14px;
  padding:12px;
}
.send{
  border-radius:14px;
  background:#111;
  color:#fff;
  border:none;
  padding:12px 14px;
  font-weight:700;
}
</style>
</head>

<body>
<div class="app">
  <div class="header">
    <div class="logo">KamaLove</div>
    <button class="msgBtn" id="openMessages">Сообщения</button>
  </div>

  <div class="stage">
    <div class="card">
      <img id="photo" class="photo">
      <div class="info">
        <div class="name" id="name">—</div>
        <div class="city" id="city">—</div>
        <div class="about" id="about">—</div>
      </div>
    </div>

    <div class="actions">
      <button class="action" id="nope">❌</button>
      <button class="action" id="like">❤️</button>
    </div>
    <div class="hint" id="hint"></div>
  </div>
</div>

<div class="overlay" id="messagesOv">
  <div class="sheet">
    <div class="sheetHeader">Сообщения</div>
    <div class="list" id="messagesList"></div>
  </div>
</div>

<script>
const API="https://kamalove-api.89123631000g.workers.dev";
const tg=window.Telegram?.WebApp;
tg?.ready();
const tg_id=tg?.initDataUnsafe?.user?.id||"111";
let current=null;

async function loadFeed(){
  const r=await fetch(API+"/feed?tg_id="+tg_id);
  const d=await r.json();
  current=d.profiles?.[0]||null;
  if(!current){return;}
  photo.src=current.photo_url;
  name.textContent=current.name+", "+current.age;
  city.textContent=current.city;
  about.textContent=current.about;
}
async function swipe(a){
  if(!current)return;
  await fetch(API+"/swipe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tg_id,profile_id:current.id,action:a})});
  loadFeed();
}
like.onclick=()=>swipe("like");
nope.onclick=()=>swipe("nope");

openMessages.onclick=async()=>{
  messagesOv.style.display="flex";
  const r=await fetch(API+"/matches?tg_id="+tg_id);
  const d=await r.json();
  messagesList.innerHTML="";
  (d.matches||[]).forEach(m=>{
    const i=document.createElement("div");
    i.className="item";
    i.innerHTML=`<img class="ava" src="${m.photo_url}"><div><b>${m.name}</b><br><small>${m.city}</small></div>`;
    messagesList.appendChild(i);
  });
};

loadFeed();
</script>
</body>
</html>
