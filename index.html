<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>KamaLove</title>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
      background: #fff;
      color: #111;
    }
    .wrap {
      max-width: 720px;
      margin: 0 auto;
      padding: 12px;
    }
    .topbar {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }
    .tabs {
      display:flex;
      gap:8px;
    }
    .tab {
      border: 1px solid #ddd;
      background:#fff;
      padding: 8px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-size: 14px;
    }
    .tab.active {
      border-color:#111;
      font-weight:600;
    }
    .small {
      font-size: 12px;
      color:#666;
    }
    .card {
      border: 1px solid #eee;
      border-radius: 14px;
      overflow: hidden;
      background:#fff;
    }
    .photo {
      width:100%;
      aspect-ratio: 4/5;
      background:#f3f3f3;
      display:block;
      object-fit: cover;
    }
    .content {
      padding: 12px;
    }
    .nameRow {
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }
    .name {
      font-size: 20px;
      font-weight: 700;
    }
    .meta {
      color:#666;
      font-size: 13px;
      text-align:right;
      white-space:nowrap;
    }
    .about {
      color:#333;
      font-size: 14px;
      line-height: 1.35;
      margin-top: 6px;
    }
    .actions {
      display:flex;
      gap:10px;
      padding: 12px;
      border-top:1px solid #eee;
      background:#fafafa;
    }
    .btn {
      flex: 1;
      border: 1px solid #ddd;
      background:#fff;
      padding: 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 16px;
      font-weight: 600;
    }
    .btn.primary {
      border-color:#111;
    }
    .row {
      display:flex;
      gap:8px;
      align-items:center;
    }
    .list {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .matchItem {
      display:flex;
      gap:10px;
      align-items:center;
      border:1px solid #eee;
      border-radius: 12px;
      padding:10px;
      cursor:pointer;
      background:#fff;
    }
    .avatar {
      width:44px;
      height:44px;
      border-radius: 12px;
      object-fit:cover;
      background:#f2f2f2;
      flex: 0 0 auto;
    }
    .matchTitle {
      font-weight:700;
      margin:0;
    }
    .matchSub {
      margin:2px 0 0;
      color:#666;
      font-size: 12px;
    }
    .chatBox {
      border: 1px solid #eee;
      border-radius: 12px;
      height: 360px;
      overflow-y: auto;
      padding: 10px;
      background:#fff;
    }
    .msg {
      margin: 6px 0;
      display:flex;
    }
    .bubble {
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid #eee;
      background:#f7f7f7;
      font-size: 14px;
      line-height: 1.3;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .msg.user { justify-content: flex-end; }
    .msg.user .bubble { background:#111; color:#fff; border-color:#111; }
    .msg.profile { justify-content: flex-start; }
    .composer {
      display:flex;
      gap:8px;
      margin-top: 10px;
    }
    .input {
      flex:1;
      border:1px solid #ddd;
      border-radius: 12px;
      padding: 12px;
      font-size: 14px;
    }
    .sendBtn {
      border:1px solid #111;
      background:#111;
      color:#fff;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight:700;
      cursor:pointer;
    }
    .hint {
      color:#666;
      font-size: 12px;
      margin-top: 8px;
    }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <div style="font-size:20px;font-weight:800;">KamaLove</div>
        <div class="small" id="who"></div>
      </div>
      <div class="tabs">
        <button class="tab active" id="tabFeed">–õ–µ–Ω—Ç–∞</button>
        <button class="tab" id="tabMatches">–ú–∞—Ç—á–∏</button>
        <button class="tab" id="tabChat">–ß–∞—Ç</button>
      </div>
    </div>

    <!-- FEED -->
    <div id="viewFeed">
      <div class="card" id="feedCard">
        <img id="feedPhoto" class="photo" src="" alt="">
        <div class="content">
          <div class="nameRow">
            <div class="name" id="feedName">‚Äî</div>
            <div class="meta" id="feedMeta">‚Äî</div>
          </div>
          <div class="about" id="feedAbout">‚Äî</div>
        </div>
        <div class="actions">
          <button class="btn" id="btnNope">üëé –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è</button>
          <button class="btn primary" id="btnLike">üëç –õ–∞–π–∫</button>
        </div>
      </div>
      <div class="hint" id="feedHint"></div>
    </div>

    <!-- MATCHES -->
    <div id="viewMatches" class="hidden">
      <div class="list" id="matchesList"></div>
      <div class="hint" id="matchesHint"></div>
    </div>

    <!-- CHAT -->
    <div id="viewChat" class="hidden">
      <div class="row" style="justify-content:space-between;margin-bottom:8px;">
        <div>
          <div style="font-weight:800;" id="chatTitle">–ß–∞—Ç</div>
          <div class="small" id="chatSub">–í—ã–±–µ—Ä–∏ –º–∞—Ç—á</div>
        </div>
      </div>

      <div class="chatBox" id="chatBox"></div>

      <div class="composer">
        <input class="input" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button class="sendBtn" id="chatSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
      <div class="hint">MVP: –ª–∞–π–∫ —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—ë—Ç –º–∞—Ç—á (–¥–ª—è –¥–µ–º–æ). –ß–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –º–∞—Ç—á–∞–º.</div>
    </div>
  </div>

<script>
  // === CONFIG ===
  const API = "https://kamalove-api.89123631000g.workers.dev";

  // === Telegram init ===
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const tg_id = (tg?.initDataUnsafe?.user?.id?.toString()) || "111";
  document.getElementById("who").textContent = "tg_id: " + tg_id;

  // State
  let currentProfile = null;
  let currentChatProfileId = null;
  let currentChatProfileName = "";

  // Tabs/views
  const tabFeed = document.getElementById("tabFeed");
  const tabMatches = document.getElementById("tabMatches");
  const tabChat = document.getElementById("tabChat");

  const viewFeed = document.getElementById("viewFeed");
  const viewMatches = document.getElementById("viewMatches");
  const viewChat = document.getElementById("viewChat");

  function setTab(active) {
    [tabFeed, tabMatches, tabChat].forEach(b => b.classList.remove("active"));
    viewFeed.classList.add("hidden");
    viewMatches.classList.add("hidden");
    viewChat.classList.add("hidden");

    if (active === "feed") {
      tabFeed.classList.add("active");
      viewFeed.classList.remove("hidden");
    } else if (active === "matches") {
      tabMatches.classList.add("active");
      viewMatches.classList.remove("hidden");
    } else if (active === "chat") {
      tabChat.classList.add("active");
      viewChat.classList.remove("hidden");
    }
  }

  tabFeed.onclick = async () => { setTab("feed"); await loadFeed(); };
  tabMatches.onclick = async () => { setTab("matches"); await loadMatches(); };
  tabChat.onclick = async () => { setTab("chat"); await loadThread(); };

  // FEED elements
  const feedPhoto = document.getElementById("feedPhoto");
  const feedName = document.getElementById("feedName");
  const feedMeta = document.getElementById("feedMeta");
  const feedAbout = document.getElementById("feedAbout");
  const feedHint = document.getElementById("feedHint");

  document.getElementById("btnLike").onclick = async () => {
    if (!currentProfile) return;
    await swipe("like");
  };
  document.getElementById("btnNope").onclick = async () => {
    if (!currentProfile) return;
    await swipe("nope");
  };

  async function loadFeed() {
    feedHint.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    try {
      const res = await fetch(`${API}/feed?tg_id=${encodeURIComponent(tg_id)}`);
      const data = await res.json();
      if (!data.ok) { feedHint.textContent = data.error || "–û—à–∏–±–∫–∞"; return; }

      const p = (data.profiles && data.profiles[0]) ? data.profiles[0] : null;
      currentProfile = p;

      if (!p) {
        feedHint.textContent = "–õ–µ–Ω—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å (–¥–ª—è –¥–µ–º–æ).";
        feedPhoto.src = "";
        feedName.textContent = "‚Äî";
        feedMeta.textContent = "‚Äî";
        feedAbout.textContent = "‚Äî";
        return;
      }

      feedPhoto.src = p.photo_url || "";
      feedName.textContent = `${p.name}, ${p.age}`;
      feedMeta.textContent = p.city || "";
      feedAbout.textContent = p.about || "";
      feedHint.textContent = "";
    } catch (e) {
      feedHint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    }
  }

  async function swipe(action) {
    feedHint.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º...";
    try {
      const res = await fetch(`${API}/swipe`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          tg_id,
          profile_id: currentProfile.id,
          action
        })
      });
      const data = await res.json();
      if (!data.ok) { feedHint.textContent = data.error || "–û—à–∏–±–∫–∞"; return; }

      if (action === "like" && data.matched) {
        feedHint.textContent = "–ï—Å—Ç—å –º–∞—Ç—á! –û—Ç–∫—Ä–æ–π ¬´–ú–∞—Ç—á–∏¬ª ‚Üí –≤—ã–±–µ—Ä–∏ —á–∞—Ç.";
      } else {
        feedHint.textContent = "";
      }

      await loadFeed();
    } catch (e) {
      feedHint.textContent = "–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏";
    }
  }

  // MATCHES
  const matchesList = document.getElementById("matchesList");
  const matchesHint = document.getElementById("matchesHint");

  async function loadMatches() {
    matchesHint.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞...";
    matchesList.innerHTML = "";
    try {
      const res = await fetch(`${API}/matches?tg_id=${encodeURIComponent(tg_id)}`);
      const data = await res.json();
      if (!data.ok) { matchesHint.textContent = data.error || "–û—à–∏–±–∫–∞"; return; }

      const items = data.matches || [];
      if (items.length === 0) {
        matchesHint.textContent = "–ú–∞—Ç—á–µ–π –ø–æ–∫–∞ –Ω–µ—Ç. –ü–æ—Å—Ç–∞–≤—å –ª–∞–π–∫ –≤ –ª–µ–Ω—Ç–µ.";
        return;
      }

      matchesHint.textContent = "";
      items.forEach(m => {
        const div = document.createElement("div");
        div.className = "matchItem";
        div.onclick = () => openChat(m.profile_id, m.name);

        const img = document.createElement("img");
        img.className = "avatar";
        img.src = m.photo_url || "";

        const info = document.createElement("div");
        const title = document.createElement("div");
        title.className = "matchTitle";
        title.textContent = `${m.name}, ${m.age}`;

        const sub = document.createElement("div");
        sub.className = "matchSub";
        sub.textContent = (m.city || "") + (m.about ? " ‚Ä¢ " + m.about : "");

        info.appendChild(title);
        info.appendChild(sub);

        div.appendChild(img);
        div.appendChild(info);
        matchesList.appendChild(div);
      });
    } catch (e) {
      matchesHint.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
    }
  }

  function openChat(profileId, name) {
    currentChatProfileId = profileId;
    currentChatProfileName = name || "";
    document.getElementById("chatTitle").textContent = currentChatProfileName ? `–ß–∞—Ç: ${currentChatProfileName}` : "–ß–∞—Ç";
    document.getElementById("chatSub").textContent = `profile_id: ${profileId}`;
    setTab("chat");
    loadThread();
  }

  // CHAT
  const chatBox = document.getElementById("chatBox");
  const chatInput = document.getElementById("chatInput");
  const chatSend = document.getElementById("chatSend");

  chatSend.onclick = async () => {
    const text = (chatInput.value || "").trim();
    if (!text) return;
    if (!currentChatProfileId) return;

    chatSend.disabled = true;
    try {
      const res = await fetch(`${API}/message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ tg_id, profile_id: currentChatProfileId, text })
      });
      const data = await res.json();
      if (data.ok) {
        chatInput.value = "";
        await loadThread();
      }
    } finally {
      chatSend.disabled = false;
    }
  };

  async function loadThread() {
    chatBox.innerHTML = "";
    if (!currentChatProfileId) {
      chatBox.innerHTML = `<div class="small">–û—Ç–∫—Ä–æ–π –≤–∫–ª–∞–¥–∫—É ¬´–ú–∞—Ç—á–∏¬ª –∏ –≤—ã–±–µ—Ä–∏ —á–µ–ª–æ–≤–µ–∫–∞.</div>`;
      return;
    }

    try {
      const res = await fetch(`${API}/thread?tg_id=${encodeURIComponent(tg_id)}&profile_id=${encodeURIComponent(currentChatProfileId)}`);
      const data = await res.json();
      if (!data.ok) {
        chatBox.innerHTML = `<div class="small">${data.error || "–û—à–∏–±–∫–∞"}</div>`;
        return;
      }
      const msgs = data.messages || [];
      if (msgs.length === 0) {
        chatBox.innerHTML = `<div class="small">–ù–∞–ø–∏—à–∏ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ.</div>`;
        return;
      }

      msgs.forEach(m => {
        const row = document.createElement("div");
        row.className = "msg " + (m.sender === "user" ? "user" : "profile");
        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = m.text;
        row.appendChild(bubble);
        chatBox.appendChild(row);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    } catch (e) {
      chatBox.innerHTML = `<div class="small">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`;
    }
  }

  // Start
  (async function init() {
    setTab("feed");
    await loadFeed();
  })();
</script>

</body>
</html>
